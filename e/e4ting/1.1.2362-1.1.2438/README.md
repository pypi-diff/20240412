# Comparing `tmp/e4ting-1.1.2362-py3-none-any.whl.zip` & `tmp/e4ting-1.1.2438-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,81 +1,81 @@
-Zip file size: 116433 bytes, number of entries: 79
--rw-r--r--  2.0 unx     5982 b- defN 24-Apr-09 10:01 celerys/__init__.py
--rw-r--r--  2.0 unx     3339 b- defN 24-Apr-09 10:01 celerys/app.py
--rw-r--r--  2.0 unx      802 b- defN 24-Apr-09 10:01 celerys/test.app.py
--rw-r--r--  2.0 unx     1301 b- defN 24-Apr-09 10:01 celerys/test.client.py
--rw-r--r--  2.0 unx     1804 b- defN 24-Apr-09 10:01 celerys/wsapp.py
--rw-r--r--  2.0 unx        0 b- defN 24-Apr-09 10:01 celerys/tasks/__init__.py
--rw-r--r--  2.0 unx    10115 b- defN 24-Apr-09 10:01 celerys/tasks/server.py
--rw-r--r--  2.0 unx     2280 b- defN 24-Apr-09 10:01 celerys/tasks/task.py
--rw-r--r--  2.0 unx      365 b- defN 24-Apr-09 10:01 common/__init__.py
--rw-r--r--  2.0 unx     1075 b- defN 24-Apr-09 10:01 common/ai.py
--rw-r--r--  2.0 unx    12296 b- defN 24-Apr-09 10:01 common/baserequest.py
--rw-r--r--  2.0 unx     2235 b- defN 24-Apr-09 10:01 common/capture.py
--rw-r--r--  2.0 unx     5710 b- defN 24-Apr-09 10:01 common/dbpoker.py
--rw-r--r--  2.0 unx     7940 b- defN 24-Apr-09 10:01 common/mongo.py
--rw-r--r--  2.0 unx    22846 b- defN 24-Apr-09 10:01 common/util.py
--rw-r--r--  2.0 unx     3880 b- defN 24-Apr-09 10:01 common/utilaliyun.py
--rw-r--r--  2.0 unx     6781 b- defN 24-Apr-09 10:01 common/utilcache.py
--rw-r--r--  2.0 unx     2448 b- defN 24-Apr-09 10:01 common/utildingtalk.py
--rw-r--r--  2.0 unx     5421 b- defN 24-Apr-09 10:01 common/utilmail.py
--rw-r--r--  2.0 unx     1498 b- defN 24-Apr-09 10:01 common/utilparallel.py
--rw-r--r--  2.0 unx    23958 b- defN 24-Apr-09 10:01 common/utilredis.py
--rw-r--r--  2.0 unx     2842 b- defN 24-Apr-09 10:01 common/utils.py
--rw-r--r--  2.0 unx     2952 b- defN 24-Apr-09 10:01 common/utilsamba.py
--rw-r--r--  2.0 unx     3010 b- defN 24-Apr-09 10:01 common/utiltask.py
--rw-r--r--  2.0 unx    11837 b- defN 24-Apr-09 10:01 common/utilui.py
--rw-r--r--  2.0 unx    23304 b- defN 24-Apr-09 10:01 common/utilwechat.py
--rw-r--r--  2.0 unx     3624 b- defN 24-Apr-09 10:01 common/weixin.py
--rw-r--r--  2.0 unx      681 b- defN 24-Apr-09 10:01 e4ting/__init__.py
--rw-r--r--  2.0 unx      130 b- defN 24-Apr-09 10:01 e4ting/acl/__init__.py
--rw-r--r--  2.0 unx     2324 b- defN 24-Apr-09 10:01 e4ting/acl/base.py
--rwxr-xr-x  2.0 unx      267 b- defN 24-Apr-09 10:01 e4ting/acl/models/admin.model
--rwxr-xr-x  2.0 unx       73 b- defN 24-Apr-09 10:01 e4ting/acl/models/admin.policy
--rw-r--r--  2.0 unx     1517 b- defN 24-Apr-09 10:01 e4ting/api/__init__.py
--rw-r--r--  2.0 unx     6049 b- defN 24-Apr-09 10:01 e4ting/api/cas.py
--rw-r--r--  2.0 unx     1245 b- defN 24-Apr-09 10:01 e4ting/api/frp.py
--rw-r--r--  2.0 unx    10613 b- defN 24-Apr-09 10:01 e4ting/api/spug.py
--rw-r--r--  2.0 unx      372 b- defN 24-Apr-09 10:01 e4ting/cache/__init__.py
--rw-r--r--  2.0 unx     4872 b- defN 24-Apr-09 10:01 e4ting/cache/cache.py
--rw-r--r--  2.0 unx      183 b- defN 24-Apr-09 10:01 e4ting/cluster/__init__.py
--rw-r--r--  2.0 unx     3935 b- defN 24-Apr-09 10:01 e4ting/cluster/callee.py
--rw-r--r--  2.0 unx     7394 b- defN 24-Apr-09 10:01 e4ting/cluster/cloud.py
--rw-r--r--  2.0 unx     2624 b- defN 24-Apr-09 10:01 e4ting/cluster/control.py
--rw-r--r--  2.0 unx     8457 b- defN 24-Apr-09 10:01 e4ting/cluster/fuse.py
--rw-r--r--  2.0 unx      362 b- defN 24-Apr-09 10:01 e4ting/db/__init__.py
--rw-r--r--  2.0 unx     1464 b- defN 24-Apr-09 10:01 e4ting/db/kaf.py
--rw-r--r--  2.0 unx     7037 b- defN 24-Apr-09 10:01 e4ting/db/pymongos.py
--rw-r--r--  2.0 unx     2698 b- defN 24-Apr-09 10:01 e4ting/db/utilredis.py
--rw-r--r--  2.0 unx      938 b- defN 24-Apr-09 10:01 e4ting/etc/__init__.py
--rw-r--r--  2.0 unx     2863 b- defN 24-Apr-09 10:01 e4ting/etc/utilyaml.py
--rw-r--r--  2.0 unx     1203 b- defN 24-Apr-09 10:01 e4ting/log/__init__.py
--rw-r--r--  2.0 unx     2167 b- defN 24-Apr-09 10:01 e4ting/log/all_exception.py
--rw-r--r--  2.0 unx     1252 b- defN 24-Apr-09 10:01 e4ting/log/otherhandle.py
--rw-r--r--  2.0 unx      162 b- defN 24-Apr-09 10:01 e4ting/net/__init__.py
--rw-r--r--  2.0 unx     1363 b- defN 24-Apr-09 10:01 e4ting/net/iface.py
--rw-r--r--  2.0 unx      174 b- defN 24-Apr-09 10:01 e4ting/server/__init__.py
--rw-r--r--  2.0 unx      580 b- defN 24-Apr-09 10:01 e4ting/server/call.py
--rw-r--r--  2.0 unx     8385 b- defN 24-Apr-09 10:01 e4ting/server/e4ting_pb2.py
--rw-r--r--  2.0 unx    29967 b- defN 24-Apr-09 10:01 e4ting/server/e4ting_pb2_grpc.py
--rw-r--r--  2.0 unx     2127 b- defN 24-Apr-09 10:01 e4ting/server/restful.py
--rw-r--r--  2.0 unx     1404 b- defN 24-Apr-09 10:01 e4ting/server/rpc.py
--rw-r--r--  2.0 unx     1420 b- defN 24-Apr-09 10:01 e4ting/server/util.py
--rw-r--r--  2.0 unx      168 b- defN 24-Apr-09 10:01 e4ting/task/__init__.py
--rw-r--r--  2.0 unx     4305 b- defN 24-Apr-09 10:01 e4ting/task/base.py
--rw-r--r--  2.0 unx     2241 b- defN 24-Apr-09 10:01 e4ting/task/celeryproxy.py
--rw-r--r--  2.0 unx     1416 b- defN 24-Apr-09 10:01 e4ting/task/master.py
--rw-r--r--  2.0 unx     1966 b- defN 24-Apr-09 10:01 e4ting/task/worker.py
--rw-r--r--  2.0 unx      420 b- defN 24-Apr-09 10:01 e4ting/util/__init__.py
--rw-r--r--  2.0 unx    22781 b- defN 24-Apr-09 10:01 e4ting/util/common.py
--rw-r--r--  2.0 unx     1992 b- defN 24-Apr-09 10:01 e4ting/util/feichang.py
--rw-r--r--  2.0 unx     6067 b- defN 24-Apr-09 10:01 e4ting/util/fuser.py
--rw-r--r--  2.0 unx     3091 b- defN 24-Apr-09 10:01 e4ting/util/hardware.py
--rw-r--r--  2.0 unx     7172 b- defN 24-Apr-09 10:01 e4ting/util/remote_fuser.py
--rw-r--r--  2.0 unx      705 b- defN 24-Apr-09 10:01 e4ting/util/rsa.py
--rw-r--r--  2.0 unx     2038 b- defN 24-Apr-09 10:01 e4ting/util/url2img.py
--rw-r--r--  2.0 unx     8926 b- defN 24-Apr-09 10:01 e4ting/util/util.py
--rw-r--r--  2.0 unx       54 b- defN 24-Apr-09 10:01 e4ting-1.1.2362.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 24-Apr-09 10:01 e4ting-1.1.2362.dist-info/WHEEL
--rw-r--r--  2.0 unx       22 b- defN 24-Apr-09 10:01 e4ting-1.1.2362.dist-info/top_level.txt
--rw-rw-r--  2.0 unx     6136 b- defN 24-Apr-09 10:01 e4ting-1.1.2362.dist-info/RECORD
-79 files, 355539 bytes uncompressed, 106999 bytes compressed:  69.9%
+Zip file size: 116660 bytes, number of entries: 79
+-rw-r--r--  2.0 unx     5982 b- defN 24-Apr-12 14:19 celerys/__init__.py
+-rw-r--r--  2.0 unx     3339 b- defN 24-Apr-12 14:19 celerys/app.py
+-rw-r--r--  2.0 unx      802 b- defN 24-Apr-12 14:19 celerys/test.app.py
+-rw-r--r--  2.0 unx     1301 b- defN 24-Apr-12 14:19 celerys/test.client.py
+-rw-r--r--  2.0 unx     1804 b- defN 24-Apr-12 14:19 celerys/wsapp.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-12 14:19 celerys/tasks/__init__.py
+-rw-r--r--  2.0 unx    10115 b- defN 24-Apr-12 14:19 celerys/tasks/server.py
+-rw-r--r--  2.0 unx     4038 b- defN 24-Apr-12 14:19 celerys/tasks/task.py
+-rw-r--r--  2.0 unx      419 b- defN 24-Apr-12 14:19 common/__init__.py
+-rw-r--r--  2.0 unx     1075 b- defN 24-Apr-12 14:19 common/ai.py
+-rw-r--r--  2.0 unx    12296 b- defN 24-Apr-12 14:19 common/baserequest.py
+-rw-r--r--  2.0 unx     2235 b- defN 24-Apr-12 14:19 common/capture.py
+-rw-r--r--  2.0 unx     5710 b- defN 24-Apr-12 14:19 common/dbpoker.py
+-rw-r--r--  2.0 unx     8034 b- defN 24-Apr-12 14:19 common/mongo.py
+-rw-r--r--  2.0 unx    22846 b- defN 24-Apr-12 14:19 common/util.py
+-rw-r--r--  2.0 unx     3880 b- defN 24-Apr-12 14:19 common/utilaliyun.py
+-rw-r--r--  2.0 unx     4420 b- defN 24-Apr-12 14:19 common/utilcache.py
+-rw-r--r--  2.0 unx     2448 b- defN 24-Apr-12 14:19 common/utildingtalk.py
+-rw-r--r--  2.0 unx     5421 b- defN 24-Apr-12 14:19 common/utilmail.py
+-rw-r--r--  2.0 unx     1498 b- defN 24-Apr-12 14:19 common/utilparallel.py
+-rw-r--r--  2.0 unx    23958 b- defN 24-Apr-12 14:19 common/utilredis.py
+-rw-r--r--  2.0 unx     2842 b- defN 24-Apr-12 14:19 common/utils.py
+-rw-r--r--  2.0 unx     2952 b- defN 24-Apr-12 14:19 common/utilsamba.py
+-rw-r--r--  2.0 unx     3010 b- defN 24-Apr-12 14:19 common/utiltask.py
+-rw-r--r--  2.0 unx    11837 b- defN 24-Apr-12 14:19 common/utilui.py
+-rw-r--r--  2.0 unx    23304 b- defN 24-Apr-12 14:19 common/utilwechat.py
+-rw-r--r--  2.0 unx     3624 b- defN 24-Apr-12 14:19 common/weixin.py
+-rw-r--r--  2.0 unx      681 b- defN 24-Apr-12 14:19 e4ting/__init__.py
+-rw-r--r--  2.0 unx      130 b- defN 24-Apr-12 14:19 e4ting/acl/__init__.py
+-rw-r--r--  2.0 unx     2324 b- defN 24-Apr-12 14:19 e4ting/acl/base.py
+-rwxr-xr-x  2.0 unx      267 b- defN 24-Apr-12 14:19 e4ting/acl/models/admin.model
+-rwxr-xr-x  2.0 unx       73 b- defN 24-Apr-12 14:19 e4ting/acl/models/admin.policy
+-rw-r--r--  2.0 unx     1517 b- defN 24-Apr-12 14:19 e4ting/api/__init__.py
+-rw-r--r--  2.0 unx     6049 b- defN 24-Apr-12 14:19 e4ting/api/cas.py
+-rw-r--r--  2.0 unx     1245 b- defN 24-Apr-12 14:19 e4ting/api/frp.py
+-rw-r--r--  2.0 unx    10613 b- defN 24-Apr-12 14:19 e4ting/api/spug.py
+-rw-r--r--  2.0 unx      402 b- defN 24-Apr-12 14:19 e4ting/cache/__init__.py
+-rw-r--r--  2.0 unx     5436 b- defN 24-Apr-12 14:19 e4ting/cache/cache.py
+-rw-r--r--  2.0 unx      183 b- defN 24-Apr-12 14:19 e4ting/cluster/__init__.py
+-rw-r--r--  2.0 unx     3935 b- defN 24-Apr-12 14:19 e4ting/cluster/callee.py
+-rw-r--r--  2.0 unx     7394 b- defN 24-Apr-12 14:19 e4ting/cluster/cloud.py
+-rw-r--r--  2.0 unx     2624 b- defN 24-Apr-12 14:19 e4ting/cluster/control.py
+-rw-r--r--  2.0 unx     8457 b- defN 24-Apr-12 14:19 e4ting/cluster/fuse.py
+-rw-r--r--  2.0 unx      362 b- defN 24-Apr-12 14:19 e4ting/db/__init__.py
+-rw-r--r--  2.0 unx     1464 b- defN 24-Apr-12 14:19 e4ting/db/kaf.py
+-rw-r--r--  2.0 unx     7049 b- defN 24-Apr-12 14:19 e4ting/db/pymongos.py
+-rw-r--r--  2.0 unx     2698 b- defN 24-Apr-12 14:19 e4ting/db/utilredis.py
+-rw-r--r--  2.0 unx      938 b- defN 24-Apr-12 14:19 e4ting/etc/__init__.py
+-rw-r--r--  2.0 unx     2863 b- defN 24-Apr-12 14:19 e4ting/etc/utilyaml.py
+-rw-r--r--  2.0 unx     1203 b- defN 24-Apr-12 14:19 e4ting/log/__init__.py
+-rw-r--r--  2.0 unx     2167 b- defN 24-Apr-12 14:19 e4ting/log/all_exception.py
+-rw-r--r--  2.0 unx     1252 b- defN 24-Apr-12 14:19 e4ting/log/otherhandle.py
+-rw-r--r--  2.0 unx      162 b- defN 24-Apr-12 14:19 e4ting/net/__init__.py
+-rw-r--r--  2.0 unx     1363 b- defN 24-Apr-12 14:19 e4ting/net/iface.py
+-rw-r--r--  2.0 unx      174 b- defN 24-Apr-12 14:19 e4ting/server/__init__.py
+-rw-r--r--  2.0 unx      580 b- defN 24-Apr-12 14:19 e4ting/server/call.py
+-rw-r--r--  2.0 unx     8385 b- defN 24-Apr-12 14:19 e4ting/server/e4ting_pb2.py
+-rw-r--r--  2.0 unx    29967 b- defN 24-Apr-12 14:19 e4ting/server/e4ting_pb2_grpc.py
+-rw-r--r--  2.0 unx     2127 b- defN 24-Apr-12 14:19 e4ting/server/restful.py
+-rw-r--r--  2.0 unx     1404 b- defN 24-Apr-12 14:19 e4ting/server/rpc.py
+-rw-r--r--  2.0 unx     1420 b- defN 24-Apr-12 14:19 e4ting/server/util.py
+-rw-r--r--  2.0 unx      168 b- defN 24-Apr-12 14:19 e4ting/task/__init__.py
+-rw-r--r--  2.0 unx     4305 b- defN 24-Apr-12 14:19 e4ting/task/base.py
+-rw-r--r--  2.0 unx     2241 b- defN 24-Apr-12 14:19 e4ting/task/celeryproxy.py
+-rw-r--r--  2.0 unx     1416 b- defN 24-Apr-12 14:19 e4ting/task/master.py
+-rw-r--r--  2.0 unx     1966 b- defN 24-Apr-12 14:19 e4ting/task/worker.py
+-rw-r--r--  2.0 unx      420 b- defN 24-Apr-12 14:19 e4ting/util/__init__.py
+-rw-r--r--  2.0 unx    22823 b- defN 24-Apr-12 14:19 e4ting/util/common.py
+-rw-r--r--  2.0 unx     1992 b- defN 24-Apr-12 14:19 e4ting/util/feichang.py
+-rw-r--r--  2.0 unx     6067 b- defN 24-Apr-12 14:19 e4ting/util/fuser.py
+-rw-r--r--  2.0 unx     3091 b- defN 24-Apr-12 14:19 e4ting/util/hardware.py
+-rw-r--r--  2.0 unx     7172 b- defN 24-Apr-12 14:19 e4ting/util/remote_fuser.py
+-rw-r--r--  2.0 unx      705 b- defN 24-Apr-12 14:19 e4ting/util/rsa.py
+-rw-r--r--  2.0 unx     2038 b- defN 24-Apr-12 14:19 e4ting/util/url2img.py
+-rw-r--r--  2.0 unx     9242 b- defN 24-Apr-12 14:19 e4ting/util/util.py
+-rw-r--r--  2.0 unx       54 b- defN 24-Apr-12 14:19 e4ting-1.1.2438.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 24-Apr-12 14:19 e4ting-1.1.2438.dist-info/WHEEL
+-rw-r--r--  2.0 unx       22 b- defN 24-Apr-12 14:19 e4ting-1.1.2438.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     6136 b- defN 24-Apr-12 14:19 e4ting-1.1.2438.dist-info/RECORD
+79 files, 356048 bytes uncompressed, 107226 bytes compressed:  69.9%
```

## zipnote {}

```diff
@@ -219,20 +219,20 @@
 
 Filename: e4ting/util/url2img.py
 Comment: 
 
 Filename: e4ting/util/util.py
 Comment: 
 
-Filename: e4ting-1.1.2362.dist-info/METADATA
+Filename: e4ting-1.1.2438.dist-info/METADATA
 Comment: 
 
-Filename: e4ting-1.1.2362.dist-info/WHEEL
+Filename: e4ting-1.1.2438.dist-info/WHEEL
 Comment: 
 
-Filename: e4ting-1.1.2362.dist-info/top_level.txt
+Filename: e4ting-1.1.2438.dist-info/top_level.txt
 Comment: 
 
-Filename: e4ting-1.1.2362.dist-info/RECORD
+Filename: e4ting-1.1.2438.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## celerys/tasks/task.py

```diff
@@ -1,10 +1,10 @@
 
 from celerys.app import BaseCeleryApp
-from e4ting  import log
+from e4ting  import log,util
 
 @BaseCeleryApp()
 def test():
     print("test")
     return True
 
 @BaseCeleryApp()
@@ -12,27 +12,57 @@
     print("test")
     return True
 
 @BaseCeleryApp()
 def node_registe_callback(host="", referer="", ip="", uuid=""):
     """ 处理注册节点时的反馈 """
     from e4ting.server.util import Recorder
+
+
     work = Recorder()
     tname = referer or host
     if not( TYPE := work.create_type(tname, detail=f"被动创建 {tname}") ):
         log.error("创建类型失败")
         return False
     log.info(TYPE)
     # username, uuid, detail, TYPE
     if not( USER := work.create_user(uuid, uuid, f"{ip} 访问 {tname} 时，自动创建", TYPE) ):
         log.error("创建账号失败")
         return False
     log.info(USER)
     ret = work.record(USER, f"{ip} 访问 {tname}", 10)
     log.info(ret)
+
+    return True
+
+@BaseCeleryApp()
+def node_view_api(uuid="", ip="", headers={}):
+    """ 用户行为记录 """
+    from e4ting.server.util import Recorder
+    from modules.webhook.events import EventBotnet
+    from modules.webhook.hooks  import HookSender
+
+    cn,prov,city = util.get_ip_local(ip)
+
+    msg = "-".join([cn,prov,city])
+
+    HookSender.execute_callbacks(dict({ k.replace('-',''):v for k,v in headers.items()}, ip=ip, localtion=msg, uuid=uuid), EventBotnet, title=EventBotnet.site)
+
+    work = Recorder()
+    tname = headers["domain"]
+    if not( TYPE := work.create_type(tname, detail=f"被动创建 {tname}") ):
+        log.error("创建类型失败")
+        return False
+    log.info(TYPE)
+    if not( USER := work.create_user(uuid, uuid, f"{ip} 访问 {tname} 时，自动创建", TYPE) ):
+        log.error("创建账号失败")
+        return False
+    log.info(USER)
+    ret = work.record(USER, f"{ip}({msg}) 访问 {tname}", 1)
+    log.info(ret)
     return True
 
 @BaseCeleryApp()
 def botnet_ws_keepalive():
     # from modules.botnet.utilbot import BotUtil
     # return BotUtil.all_keepalive()
     from e4ting.cluster.control     import NodeControl
@@ -80,7 +110,31 @@
 
     data = CasDoor().get_user(token)
     log.info(data)
     TokenCache(token).set(**data)
     TokenCache(code).set(**data)
     return True
 
+@BaseCeleryApp()
+def ssh_test(host, port=22, user="root", passwd="123456"):
+    """ 登录ssh """
+    from common.mongo import DB
+    import paramiko
+
+    # user = user or "root"
+
+    ssh = paramiko.SSHClient()
+    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
+    try:
+        ssh.connect(host, int(port), user, passwd, timeout=5)
+        stdin, stdout, stderr = ssh.exec_command("hostname")
+        # log.info(stdout.read())
+        del stdin, stdout, stderr
+        log.info(("正确的用户",host, port, user, passwd))
+        DB.SSH[f"{host}-{port}"] = dict(host=host, port=port, user=user, passwd=passwd)
+        return True
+    except KeyboardInterrupt as e:
+        raise e
+    except Exception as e:
+        log.error(e)
+        return False
+    return False
```

## common/__init__.py

```diff
@@ -8,12 +8,13 @@
         2021-07-18 14:22:58
 """
 
 # from .util      import *
 # from .mongo     import *
 # from .utilredis import *
 from .utilcache   import (
-                    INRC,
-                    RedisCache,
+                    # INRC,
+                    # RedisCache,
                     TemplateCache,
                 )
+from e4ting.cache import RedisCache,StringID,INRC
```

## common/mongo.py

```diff
@@ -163,12 +163,15 @@
 
     templates  = TABLE(db="data",  table="templates")
     robots     = TABLE(db="data",  table="robots")
     webhook    = TABLE(db="data",  table="webhook")
 
     person     = TABLE(db="data",  table="person")
     JS         = TABLE(db="JP",    table="JS")
-    clients    = TABLE(db="botnet",  table="clients")
+    clients    = TABLE(db="botnet",table="clients")
     statistics = TABLE(db="data",  table="statistics")
 
+    IP         = TABLE(db="data",  table="ip")
+    SSH        = TABLE(db="data",  table="ssh")
+
```

## common/utilcache.py

```diff
@@ -6,100 +6,15 @@
 """
 import sys,os
 import functools
 import time,json
 from pdb import set_trace as strace
 from traceback  import format_exc as dumpstack
 
-from common import util
-from common.utilredis import NewID,MapDictRedis
-
-redis_temp_running = MapDictRedis(db=0)
-
-class INRC():
-    def __init__(self, key="cache:api:total", attr="attr"):
-        self.key = key
-        self.attr = attr
-
-    def __call__(self):
-        return redis_temp_running.add(self.key, self.attr)
-
-    def __get__(self, instance, owner):
-        return redis_temp_running.add(self.key, self.attr)
-
-class StringID(INRC):
-    def __get__(self, instance, owner):
-        return str(redis_temp_running.add(self.key, self.attr))
-
-class RedisCache(object):
-    # 运行状态信息
-    attr = {"__uid__", "__key__"}
-    key  = INRC(attr="common")
-    def __init__(self, mod="", uid=0):
-        self.__uid__ = uid
-        self.__key__ = f"cache:{mod}:{str(uid)}"
-
-    def refresh(self):
-        self._time_ = time.time()
-        self._date_ = now()
-
-    def set(self, **kwargs):
-        redis_temp_running[self.__key__] = kwargs
-        # self.refresh() # Add By cdj 2021-09-28 08:48:13 绝对不可以调
-        return True
-
-    def get(self, k=None):
-        if not k:
-            # 默认读取所有配置
-            return redis_temp_running[self.__key__]
-
-        return redis_temp_running.getkey(self.__key__, k)
-
-    def pushd(self, data):
-        if not data is str:
-            data = json.dumps(data, ensure_ascii=False)
-        redis_temp_running.rc.lpush(self.__key__, data)
-
-    def popd(self, timeout=0.1):
-        data = redis_temp_running.rc.brpop(self.__key__, timeout) or "{}"
-        if data:
-            data = data[1]
-        return json.loads(data)
-
-    def keys(self):
-        # key = self.__key__.replace(self.__uid__, "*")
-        keys = redis_temp_running.keys(self.__key__)
-        pos = len(self.__key__) - 1
-        return [ _[pos:] for _ in keys ]
-
-    def exists(self):
-        # 配置项是否存在
-        return self.__key__ in redis_temp_running
-
-    def __setattr__(self, k, v):
-        # 极其危险
-        # strace()
-        if k in RedisCache.attr:
-            super().__getattribute__("__dict__")[k] = v
-            return
-
-        return self.set(**{k:v})
-
-    def __getattr__(self, k):
-        return self.get(k)
-
-    def __repr__(self):
-        return f"{self.__uid__}"
-
-    def timeout(self, howlong=31536000):
-        # 默认超时一年
-        redis_temp_running.expire(self.__key__, howlong)
-
-    def __del__(self):
-        self.timeout()
+from e4ting.cache import RedisCache,StringID,INRC
 
 class TemplateCache(RedisCache):
     key  = StringID(attr="template")
     def __init__(self, id):
         super().__init__("template", id)
 
     def __del__(self):
```

## e4ting/cache/__init__.py

```diff
@@ -1,11 +1,12 @@
 
 
 from .cache import (RedisCache,
                     INRC,
+                    StringID,
                     UUIDCache,
                     FrpCache,
                     UploadCache,
                     TokenCache,
                     DeviceCache,
                     TaskCache,
                     OnlineCache,
```

## e4ting/cache/cache.py

```diff
@@ -26,60 +26,78 @@
 
 class StringID(INRC):
     def __get__(self, instance, owner):
         return str(redis_temp_running.add(self.key, self.attr))
 
 class RedisCache(object):
     # 运行状态信息
-    attr = {"__uid__", "__key__", "__expire__"}
+    attr = {"__uid__", "__key__", "__flush__"}
+    key  = INRC(attr="common")
     def __init__(self, mod="", uid=0):
         self.__uid__ = uid
         self.__key__ = f"cache:{mod}:{str(uid)}"
+        self.__flush__ = False
 
     def refresh(self):
         self._time_ = time.time()
         self._date_ = now()
 
     def set(self, **kwargs):
-        redis_temp_running[self.__key__] = dict(kwargs, __uptime__=util.now())
+        redis_temp_running[self.__key__] = kwargs
+        self.__flush__ = True
+        # self.refresh() # Add By cdj 2021-09-28 08:48:13 绝对不可以调
         return True
 
     def get(self, k=None):
         if not k:
             # 默认读取所有配置
             return redis_temp_running[self.__key__]
 
         return redis_temp_running.getkey(self.__key__, k)
 
+    def pushd(self, data):
+        if not data is str:
+            data = json.dumps(data, ensure_ascii=False)
+        redis_temp_running.rc.lpush(self.__key__, data)
+
+    def popd(self, timeout=0.1):
+        data = redis_temp_running.rc.brpop(self.__key__, timeout) or "{}"
+        if data:
+            data = data[1]
+        return json.loads(data)
+
     def keys(self):
         # key = self.__key__.replace(self.__uid__, "*")
         keys = redis_temp_running.keys(self.__key__)
         pos = len(self.__key__) - 1
         return [ _[pos:] for _ in keys ]
 
     def exists(self):
         # 配置项是否存在
         return self.__key__ in redis_temp_running
 
     def __setattr__(self, k, v):
+        # 极其危险
+        # strace()
         if k in RedisCache.attr:
             super().__getattribute__("__dict__")[k] = v
             return
 
         return self.set(**{k:v})
 
     def __getattr__(self, k):
         return self.get(k)
 
     def __repr__(self):
         return f"{self.__uid__}"
 
     def timeout(self, howlong=31536000):
         # 默认超时一年
-        redis_temp_running.expire(self.__key__, howlong)
+        if self.__flush__:
+            redis_temp_running.expire(self.__key__, howlong)
 
     def __del__(self):
         self.timeout()
 
 class UploadCache(RedisCache):
     # 用于统计系统总共上传过多个文件
     file_id = INRC(attr="upload_num")
```

## e4ting/db/pymongos.py

```diff
@@ -144,15 +144,15 @@
 
     def len_search(self, **kwargs):
         self.login()
         return self._table.find(kwargs).count()
 
     def __len__(self):
         self.login()
-        return self._table.count()
+        return self._table.count_documents({})
 
     def count(self, **kwargs):
         self.login()
         return self._table.count_documents(kwargs)
 
     def __delitem__(self, _id):
         log.debug(str(self), "删除", _id, level=self.level)
```

## e4ting/util/__init__.py

 * *Ordering differences only*

```diff
@@ -6,15 +6,15 @@
 """
 import sys,os
 import json,time
 from pdb import set_trace as strace
 from traceback  import format_exc as dumpstack
 from textwrap import dedent
 
-from .util import *
 from .common import *
+from .util import *
 
 # def __getattr__(func):
 #     from .common import *
 #     return getattr(util, func)
 
 from .hardware import Hardware
```

## e4ting/util/common.py

```diff
@@ -747,36 +747,36 @@
 def notify_by_api(title="", text="", mod="火眼"):
     return HTTP().post("http://notify.e4ting.cn/api/v1/socket/notify/{}".format(quote(mod)),
         data = {
             "title": title,
             "text" : text,
         })
 
-def get_ip_local(ip):
-    # url = "http://ip-api.com/json/?lang=zh-CN"
-    url = "http://ip-api.com/json/{}?lang=zh-CN".format(ip)
-    try:
-        ret = HTTP().get(url, _json=True)
-        if ret["status"] == "success":
-            del ret["status"]
-            del ret["query"]
-            return ret
-    except:
-        pass
-    return None
+# def get_ip_local(ip):
+#     # url = "http://ip-api.com/json/?lang=zh-CN"
+#     url = "http://ip-api.com/json/{}?lang=zh-CN".format(ip)
+#     try:
+#         ret = HTTP().get(url, _json=True)
+#         if ret["status"] == "success":
+#             del ret["status"]
+#             del ret["query"]
+#             return ret
+#     except:
+#         pass
+#     return None
 
-def ip_local(ip):
-    from mongo import db_IPs
-    if ip in db_IPs:
-        return db_IPs[ip]
-    ret = get_ip_local(ip)
-    if ret:
-        db_IPs[ip] = ret
-        return ret
-    return None
+# def ip_local(ip):
+#     from mongo import db_IPs
+#     if ip in db_IPs:
+#         return db_IPs[ip]
+#     ret = get_ip_local(ip)
+#     if ret:
+#         db_IPs[ip] = ret
+#         return ret
+#     return None
 def get_app_dir(app="test"):
     path = os.path.join(os.getenv("APPDATA") or os.path.abspath("."), app)
     mkdir(path)
     return path
 
 def mkdir(path):
     if os.path.exists(path) == False:
```

## e4ting/util/util.py

```diff
@@ -237,14 +237,25 @@
             # log.info(ret[0])
             return ret[0]
         wrapper.python = python
         wrapper.docker = name
         return wrapper
     return _config
 
+def get_ip_local(ip):
+    # url = "http://ip-api.com/json/?lang=zh-CN"
+    url = "http://ip-api.com/json/{}?lang=zh-CN".format(ip)
+    try:
+        ret = HTTP().get(url, _json=True)
+        if ret:
+            return ret["country"], ret["regionName"], ret["city"]
+    except:
+        pass
+    return None,None,None
+
 class Timer():
     def __init__(self, *args, **kwargs):
         self.args   = args
         self.kwargs = kwargs
 
     def __enter__(self):
         self.start = time.time()
```

## Comparing `e4ting-1.1.2362.dist-info/RECORD` & `e4ting-1.1.2438.dist-info/RECORD`

 * *Files 6% similar despite different names*

```diff
@@ -1,24 +1,24 @@
 celerys/__init__.py,sha256=5kY6f4mGomU3CnusojE5QUtUDw2gZI7oTQlhFBYEfW4,5982
 celerys/app.py,sha256=Uw0QXIWlj_Z9MGQ236l-s_2UfXG3J2vWXQ2-v9PdMQM,3339
 celerys/test.app.py,sha256=YMjb58AdfskiAPavBv1I_XG3Evxkujd8iDPcRgLEnag,802
 celerys/test.client.py,sha256=KqfAwSmvV5AqeXbWH6LNS5HScsJtTsYReULhCUz9k3Y,1301
 celerys/wsapp.py,sha256=qoqYwYraDV-f9ixZaLIvwSOYg2hMIvPLc_uLkP7sYP0,1804
 celerys/tasks/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 celerys/tasks/server.py,sha256=fU6sMWSbzD2Pd6Bng_gGRNE5v31QPVgexxv4C8Cv8kc,10115
-celerys/tasks/task.py,sha256=3I4QWZlrh2lGY2Bru3VP0twrAkAtDqB90Fge_VYapfY,2280
-common/__init__.py,sha256=VsiTryVYnD1r-QalqAlaangwjDBDqdXuLvxksbOT6uE,365
+celerys/tasks/task.py,sha256=yyfKQSn92gKY0Ft8Oy5TUTKGw1J0eHpJN573K_VawU4,4038
+common/__init__.py,sha256=gW0CO2nS-uAXVASnN9PYXrQG7LdYTWNeknWucYFjWPY,419
 common/ai.py,sha256=KxuH1nQzhFlL7mJE5-WrvNi-2hhxScULrB_COzIqMiQ,1075
 common/baserequest.py,sha256=PpYz944GsLoFdr4ZsOpegvR20tzk1d6QhhHJGtW87l4,12296
 common/capture.py,sha256=Cr732LSV2CEzuL4Uqf9ZE53W1J8BJFoQx4UlnkLIez0,2235
 common/dbpoker.py,sha256=8Rx3evTgFbyIXz2e_gn7Gs7xVOjAYcWhnLEa6V03HDw,5710
-common/mongo.py,sha256=kW792HUSkIqxWt8gY3ClLjDpjbIxB48f_9Kp_fDQR_Y,7940
+common/mongo.py,sha256=LpU2QUGE2u4vwm7KtqfnI_xwd53xouUOaWpdZQb5Yc4,8034
 common/util.py,sha256=gBot5ekPeuRT3vLkqjtMQM5AEpYjxJuPoBUHLDSwgnA,22846
 common/utilaliyun.py,sha256=OllnFXFGhNJ5Qi8z-vJXQO3J4lYNt8Bk_TaBFTIeBOs,3880
-common/utilcache.py,sha256=MeJm4q1sejOJ9vzPZfFiyVOAcwf1d9dBy3QucEnzIrU,6781
+common/utilcache.py,sha256=F6IBDL9OmvY3ImsG8p2bloC02yXeFADt7fFHuE4unUY,4420
 common/utildingtalk.py,sha256=-BHAxoKwmd2jaZV0yjyK2ibeaX2701bTZ8y46VMaCEM,2448
 common/utilmail.py,sha256=vyqIW_yjwgYJu2nWfwGacZEYaiHjUwPmCpnr1NmjoOg,5421
 common/utilparallel.py,sha256=P1ZFm4OF7NQywFREwUXbza4crhwRQrVi9qSu5bW8vzo,1498
 common/utilredis.py,sha256=gMT5XkgrXgv5xHqUqE79kfqXYrpB2q9BRDKAC2XNL8E,23958
 common/utils.py,sha256=xfBQM-cdWxfgncrxRvxoh2zJ3IYs50NQ9298wVHNmGA,2842
 common/utilsamba.py,sha256=m5wwgIHMmkbfvkrimfCPvZGOoK3jVTzcycVPhfCRHns,2952
 common/utiltask.py,sha256=1Cfm_zBDoaXUgqRKNFQZR0xsuv4fJvzVhp1Yniv0_Eg,3010
@@ -30,24 +30,24 @@
 e4ting/acl/base.py,sha256=SGyoxU5xuAX6ZLCLlAIiL6XtTwZWMxdjBdxtPLcnEFQ,2324
 e4ting/acl/models/admin.model,sha256=wdSoXCxfJFdhg_pAYQp0yN7idsTPgWpM7htRywE247E,267
 e4ting/acl/models/admin.policy,sha256=XpeCWPix4ZyentT197qqmw9UvMSn_nlE0K5hU6n_t6Y,73
 e4ting/api/__init__.py,sha256=RSOyFrjPInODWIrcG-QQ21nQiMKHejTe_VW9bT9UTy0,1517
 e4ting/api/cas.py,sha256=D3LdHQr45rMDBVrHgkQF0YvxYlx3eAcurzVr48__zMg,6049
 e4ting/api/frp.py,sha256=JfyknufL02Ux-YjrUz4S45eguM7DEDsvlTLVvRuk1cw,1245
 e4ting/api/spug.py,sha256=RbpxVHf63Jr2QmV_Bxq6CPPxQfhy2kBlqy8zukgH04g,10613
-e4ting/cache/__init__.py,sha256=AzP707CedEqyVeAoS_TrMT8cC1L3booIdNyRqTgMhAw,372
-e4ting/cache/cache.py,sha256=ywOWiNBRkFwcA3H0ALvcZf3q6EuEQmYB3iWiacXPt-I,4872
+e4ting/cache/__init__.py,sha256=0KbmJUAILUUcdqsyp1tf7tmQ_Ac_Bm2bF4J-qjvsMn0,402
+e4ting/cache/cache.py,sha256=UfM-gulZDltGR3p5M1d7g9-xv2aSivsyGYW3J4Iov_E,5436
 e4ting/cluster/__init__.py,sha256=N7O_VIa1mV0zOunTtsjrJL_4OdYKvIaOaY67UiVfK78,183
 e4ting/cluster/callee.py,sha256=fo61mhEC12D_RDT0ETUtlwl_4NgCtoSgXFocGtVOLQY,3935
 e4ting/cluster/cloud.py,sha256=bUz3YteJBYdstFNGPhbIkqDN-cY0w_v3zTZ2okrrCmk,7394
 e4ting/cluster/control.py,sha256=6NzmdsztffY9vjK1gmdDp6bjtl8WIZNCynZqsRghmUc,2624
 e4ting/cluster/fuse.py,sha256=otq1lnX1yaNrWd8EbmCtLeIj-ew6BUUaweRPbBfvVOM,8457
 e4ting/db/__init__.py,sha256=MuJO2x3zr8GXU21W-AALel-P-RuH9CtWAn31oCGASQ4,362
 e4ting/db/kaf.py,sha256=iqCJ21HVKtuUcT7Fhxb1ZPFr9m2n9QN_a60DNDIXAOs,1464
-e4ting/db/pymongos.py,sha256=7_drAxjQReHXIUyZGFHzAE1HZUMtmw98pPll_3IdXik,7037
+e4ting/db/pymongos.py,sha256=bkiu6LNvTXgc73kdK5w7aS1IOeE8oj9dcUXdnAxqQ4k,7049
 e4ting/db/utilredis.py,sha256=NTq5Qs-b8zWVyo5mkOngPSWJ_4nqq0BWL2froQEc4qk,2698
 e4ting/etc/__init__.py,sha256=cvatd3eJrfw5BLtpsHyi1Krag97k26YI-OuxYKuHnB8,938
 e4ting/etc/utilyaml.py,sha256=vqB6R-3Vxfz0OLFTYMr4FfaYZbcbGcEuL7bJ8H1_zQ4,2863
 e4ting/log/__init__.py,sha256=1N1Tg56qK7jN9IhkBya6yKAMm3AE4C_t7dekE67JYas,1203
 e4ting/log/all_exception.py,sha256=m09t0FR2o4kzeR_qlzTIQxHO-f6ZkFlcV7iRiKZNYxs,2167
 e4ting/log/otherhandle.py,sha256=6xeuAufB_frtUT-xKdAvHIWpl7nFT8EfFJZ36uErfCU,1252
 e4ting/net/__init__.py,sha256=EeMypkivZYELMAFpGR6ta_9fTn1e8tl_mkWXoHZbfwM,162
@@ -60,20 +60,20 @@
 e4ting/server/rpc.py,sha256=g1OzsiwXiTE1M51jk_IkCTUZwSB1oclZEy7jePHiLRA,1404
 e4ting/server/util.py,sha256=h11evQY5aGMIUCTp-ozqH-UR3bAobr4oGAuPfpgjXsk,1420
 e4ting/task/__init__.py,sha256=NUz0Vyl7dk7bXxsfvCKceLwl_o66IRDxV92Ao0ccQKk,168
 e4ting/task/base.py,sha256=727nfSR7P110Vpd7AUCvyHYoai6KxTbdqKoFTBgOKiU,4305
 e4ting/task/celeryproxy.py,sha256=fwkvhozBq7BgYRthdEnD19cqsMHQUr54o1c2pR6Eyd4,2241
 e4ting/task/master.py,sha256=Gwv-kB37qN_GaBcCtK7QtXF01Bn4GNRbET1EIzqqj4w,1416
 e4ting/task/worker.py,sha256=yYYCBgKZRtkG7i5y6VYxYfSZFkI1z_Trt7z0C_oILgc,1966
-e4ting/util/__init__.py,sha256=-XSmX9NCqz-Ssp03ikEr3XaQRTR60ElpEZhBAfS6mns,420
-e4ting/util/common.py,sha256=ZjNwotEyaQ98dXWiBwWufinCV1LawwZLV8_8nhvckqg,22781
+e4ting/util/__init__.py,sha256=gb4jYL3-UISuNxIMGTugT8Fs6xU7QNImdYjTUkzwqxg,420
+e4ting/util/common.py,sha256=EYFciiucTtGCXRqL63Bs1r4ahHHFZ4TpW8Iv9BomfXU,22823
 e4ting/util/feichang.py,sha256=vg8ozhvMWD8rH0QKhpgmqwub1k-uPOTij0nJM46eaRc,1992
 e4ting/util/fuser.py,sha256=uv_FC6ykbvBMGmsF14AaFbfdR_MQ9Rg7QKEjjpBQjnU,6067
 e4ting/util/hardware.py,sha256=Lggg1RzeCFpgVFc0Xf_2rHTNBQJvn1bjbn53xsmSNKw,3091
 e4ting/util/remote_fuser.py,sha256=majAgjjQx1Jf2ziozDNwebNgEpz9Bi5eR0wPwGjmVPs,7172
 e4ting/util/rsa.py,sha256=uakqI6fblQpjF-D8xnLvT6QoVVojw-w-dbHHu0vUE2c,705
 e4ting/util/url2img.py,sha256=km0FY74dhUt5VdD_5X78v3YJVtxmtK7H60d-dI7lhUk,2038
-e4ting/util/util.py,sha256=yMd9QPbrpVrmqSdmGfwU5aWqpjy-n4Hy7KMrwUNZPBU,8926
-e4ting-1.1.2362.dist-info/METADATA,sha256=cWmRG8-JMsQowtGGeVEiTTuqVNcSwxp3oJtxt65pFq8,54
-e4ting-1.1.2362.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
-e4ting-1.1.2362.dist-info/top_level.txt,sha256=FOXYrwZIzEGe_-8MjO-MyYRLlhDuGbeoyZsIXtwVhL4,22
-e4ting-1.1.2362.dist-info/RECORD,,
+e4ting/util/util.py,sha256=ikwiRkkaXRoe8VSE0RMGLHqNDQp49MtR4gfbiB0F5F0,9242
+e4ting-1.1.2438.dist-info/METADATA,sha256=mknFAAukNoPZJvok07Alx9fP9t7RrgTGpJ9cRcWK06Y,54
+e4ting-1.1.2438.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
+e4ting-1.1.2438.dist-info/top_level.txt,sha256=FOXYrwZIzEGe_-8MjO-MyYRLlhDuGbeoyZsIXtwVhL4,22
+e4ting-1.1.2438.dist-info/RECORD,,
```

